@page "/admin"
@using OrderRice.Model
@using OrderRice.Service
@using OrderRice.Pages.Admin.Components

@inject OrderRiceService orderRiceService
@inject IDialogService DialogService
@inject IDialogService Dialog

<MudText Typo="Typo.h3" Align="Align.Center">Admin</MudText>
<hr />
<MudPaper Square="true">
    <MudContainer Style="display: flex; justify-content: center;">
        <div>
            @if (!isLogin)
            {
                <div style="display: inline-flex; justify-content: center;">
                    <MudItem xs="12">
                        <MudTextField @bind-Value="Key"
                                      Label="Login"
                                      InputType="InputType.Password"
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      Immediate="true"
                                      AutoFocus="true"
                                      OnKeyPress="KeyPressLogin">
                        </MudTextField>
                    </MudItem>
                    <MudButton Variant="Variant.Filled"
                               Style="background-color: green; color: white;" Class="ml-2"
                               OnClick="HandleAdminLogin">
                        Login
                    </MudButton>
                </div>
            }
            else
            {
                <div style="display: inline-flex; justify-content: center;">
                    <MudItem xs="12">
                        <MudTextField @bind-Value="GiaCom"
                                      Label="Giá cơm"
                                      InputType="InputType.Text"
                                      Variant="Variant.Text"
                                      Margin="Margin.Dense"
                                      Immediate="true">
                        </MudTextField>
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="GiaDoAn"
                                      Label="Giá đồ ăn"
                                      InputType="InputType.Text"
                                      Variant="Variant.Text"
                                      Margin="Margin.Dense"
                                      class="ml-1"
                                      Immediate="true">
                        </MudTextField>
                    </MudItem>
                </div>
                <AddMenu GiaCom="@GiaCom" GiaDoAn="@GiaDoAn" OnEventChange="@OnEventChangeDish" />
                <ListMenu Dishs="@dishs" OnEventChange="@OnEventChangeDish" />
                <ListUser Dishs="@dishs" Users="@users" OnEventChange="@OnEventChangeUser" />
                <ReportTable @ref="_reportTable" Dishs="@dishs" Users="@users" OnEventChange="@OnEventChangeUser" />
                <MudButton Variant="Variant.Filled"
                           Color="Color.Error"
                           Class="ma-2"
                           OnClick="HandleDeleteAllMenuAllUser">
                    Delete All Menu, All User Order
                </MudButton>
            }
        </div>
    </MudContainer>
</MudPaper>


@code {
    int GiaCom { get; set; } = 22;
    int GiaDoAn { get; set; } = 18;

    ReportTable _reportTable;
    string Password { get; set; } = "a";

    string Key { get; set; }
    bool isLogin { get; set; } = false;

    List<Dish> dishs;
    List<User> users;

    protected override async Task OnInitializedAsync()
    {
        dishs = await orderRiceService.GetDishAsync();
        users = await orderRiceService.GetUserAsync();
    }

    void KeyPressLogin(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            HandleAdminLogin();
        }
    }

    void HandleAdminLogin()
    {
        if (Key == Password)
        {
            isLogin = true;
        }
        else
        {
            @*TODO: show message sai password*@
        }
    }
    void HandleEditGia()
    {

    }

    async void OnEventChangeDish(string idDish)
    {
        dishs = new();
        dishs = await orderRiceService.GetDishAsync();
        _reportTable.Refresh();
    }

    async void OnEventChangeUser(string idUser)
    {
        users = new();
        users = await orderRiceService.GetUserAsync();
        _reportTable.Refresh();
    }

    async void HandleDeleteAllMenuAllUser()
    {
        var parameters = new DialogParameters();
        parameters.Add("ContentText", "Do you really want to delete Menu and User Order?");
        parameters.Add("ButtonText", "Delete");
        parameters.Add("Color", Color.Error);

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall };

        var dialog = DialogService.Show<Dialog>("Delete", parameters, options);
        var result = await dialog.Result;
        if (!result.Cancelled)
        {
            await orderRiceService.DeleteAllDishAsync();
            await orderRiceService.DeleteAllUserAsync();
            dishs = new();
            users = new();
            _reportTable.Refresh();
            StateHasChanged();
        }
    }

    async void OnClickAddMenu()
    {
        dishs = await orderRiceService.GetDishAsync();
    }
}