@using OrderRice.Model

<style>
    #table {
        border-collapse: collapse;
        width: 100%;
    }

        #table td, #table th {
            border: 1px solid #ddd;
            padding: 8px;
        }

        #table tr:hover {
            background-color: #ddd;
        }

        #table th {
            padding-top: 12px;
            padding-bottom: 12px;
            text-align: left;
            background-color: #4CAF50;
            color: white;
        }
</style>

<table id="table">
    <thead>
        <tr>
            <th>Title</th>
            <th>Content</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Tiền đã nhận:</td>
            <td>@TienDaNhan k</td>
        </tr>
        <tr>
            <td>Tiền cần thối:</td>
            <td>@TienCanThoi</td>
        </tr>
        <tr>
            <td><b>Số lượng:</b></td>
            <td>@SoLuongDish</td>
        </tr>
        <tr>
            <td><b>Tổng bill:</b></td>
            <td>@TongBill k</td>
        </tr>
        <tr>
            <td><b>Output:</b></td>
            <td>@strOutput</td>
        </tr>
    </tbody>
</table>

@code {
    [Parameter]
    public List<Dish> Dishs { get; set; }
    [Parameter]
    public List<User> Users { get; set; }
    [Parameter]
    public EventCallback<string> OnEventChange { get; set; }

    int TienDaNhan { get; set; } = 0;
    int TongBill { get; set; } = 0;
    string strOutput { get; set; } = "";
    int SoLuongDish { get; set; } = 0;
    string TienCanThoi { get; set; } = "";

    void CreateReport()
    {
        TienDaNhan = 0;
        TongBill = 0;
        strOutput = "";
        SoLuongDish = 0;
        TienCanThoi = "";

        List<string> nameDishs = new();
        int tempTienThoi;
        foreach (var user in Users)
        {
            TienDaNhan += user.tienDaNhan;
            TongBill += user.tongTien;
            if(user.dishs != null)
                foreach (var dish in user.dishs)
                {
                    nameDishs.Add(dish.name);
                    SoLuongDish++;
                }
            tempTienThoi = user.tienDaNhan - user.tongTien;
            if (tempTienThoi > 0)
                TienCanThoi += user.name + ": " + tempTienThoi.ToString() + "k | ";
        }
        @*var userDishOrderd = Users.SelectMany(c => c.dish.Split(','));*@
        var distCount = nameDishs.GroupBy(c => c).Select(c => $"{c.Count()} phần {c.Key}");
        strOutput = String.Join(", ", distCount);
    }

    protected override void OnInitialized()
    {
        CreateReport();
    }

    public void Refresh()
    {
        CreateReport();
        @*StateHasChanged();*@
    }
}
